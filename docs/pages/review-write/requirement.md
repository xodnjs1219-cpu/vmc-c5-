# 리뷰 작성 페이지 요구사항

## 페이지 정보

- **페이지명**: 리뷰 작성 페이지
- **경로**: `/write?placeId=[placeId]`
- **복잡도 레벨**: Level 1 (기본 상태만)
- **관련 유스케이스**: 002 - 신규 리뷰 작성 및 저장

## 페이지 개요

사용자가 특정 장소(음식점)에 대한 리뷰를 작성하고 저장하는 페이지입니다. 회원가입 없이 비밀번호 기반의 익명 리뷰를 작성할 수 있습니다.

## 진입 경로

1. **메인 페이지에서 검색 후 진입**
   - 사용자가 메인 페이지(`/`)에서 장소를 검색
   - 검색 결과 배너의 '리뷰 작성하기' 버튼 클릭
   - `/write?placeId=[placeId]` 로 이동

2. **장소 상세 페이지에서 진입**
   - 사용자가 장소 상세 페이지(`/place/[placeId]`)에 진입
   - '리뷰 작성하기' 버튼 클릭
   - `/write?placeId=[placeId]` 로 이동

## UI 구성 요소

### 1. 장소 정보 섹션 (상단 고정)
- 대상 음식점의 기본 정보 표시
  - 가게명
  - 주소
  - 업종 (카테고리)

### 2. 리뷰 작성 폼
페이지의 핵심 입력 영역으로, 다음 필드들로 구성됩니다:

#### 2.1. 작성자명 입력 필드
- 타입: 텍스트 입력
- 라벨: "작성자명"
- Placeholder: "닉네임을 입력하세요"
- 유효성 규칙:
  - 필수 입력
  - 최소 1자 ~ 최대 50자

#### 2.2. 평점 선택 필드
- 타입: 별점 선택 (Star Rating)
- 라벨: "평점"
- 선택 범위: 1~5점 (정수)
- 유효성 규칙:
  - 필수 선택

#### 2.3. 리뷰 내용 입력 필드
- 타입: 텍스트 영역 (Textarea)
- 라벨: "리뷰 내용"
- Placeholder: "방문 경험을 공유해주세요"
- 유효성 규칙:
  - 필수 입력
  - 최소 1자 ~ 최대 1000자

#### 2.4. 비밀번호 입력 필드
- 타입: 비밀번호 입력 (Password)
- 라벨: "비밀번호"
- Placeholder: "리뷰 수정/삭제 시 사용할 비밀번호"
- 안내 메시지: "이 비밀번호는 나중에 리뷰를 수정하거나 삭제할 때 필요합니다"
- 유효성 규칙:
  - 필수 입력
  - 최소 4자 ~ 최대 100자

### 3. 액션 버튼
- **저장 버튼**
  - 레이블: "저장" 또는 "리뷰 작성"
  - 클릭 시: 폼 제출 및 API 요청
  - 로딩 중: 버튼 비활성화 및 로딩 표시
- **취소 버튼** (선택사항)
  - 레이블: "취소"
  - 클릭 시: 이전 페이지로 이동

## 사용자 행동 및 데이터 흐름

### 1. 페이지 진입 (초기 로딩)

**사용자 행동:**
- URL 파라미터 `placeId`와 함께 페이지 접근

**데이터 흐름:**
1. URL에서 `placeId` 추출
2. `placeId` 유효성 검증 (UUID 형식)
3. (선택사항) 장소 정보 API 호출하여 장소명, 주소, 업종 조회
4. 조회된 장소 정보를 상단에 표시
5. 빈 폼 렌더링

**Edge Cases:**
- `placeId`가 없거나 유효하지 않은 경우 → 메인 페이지로 리다이렉트 또는 에러 메시지 표시
- 장소 정보 조회 실패 시 → 에러 메시지 표시

### 2. 폼 입력

**사용자 행동:**
- 작성자명 입력
- 평점 선택 (별점 클릭)
- 리뷰 내용 입력
- 비밀번호 입력

**데이터 흐름:**
1. 각 필드의 입력값이 폼 상태에 저장됨
2. 실시간 유효성 검증 (선택사항)
   - 입력 필드를 벗어날 때 (onBlur) 유효성 검사
   - 에러 메시지 표시 (유효성 실패 시)

**상태 변화:**
- `authorName`: "" → "맛객"
- `rating`: null → 5
- `content`: "" → "정말 맛있어요!"
- `password`: "" → "1234"

### 3. 폼 제출 (저장 버튼 클릭)

**사용자 행동:**
- '저장' 버튼 클릭

**데이터 흐름:**

#### 3.1. 클라이언트 측 유효성 검증
1. 모든 필수 필드 입력 확인
2. 각 필드의 형식 및 길이 규칙 확인
3. 검증 실패 시 → 에러 메시지 표시, 제출 중단
4. 검증 성공 시 → API 요청 진행

#### 3.2. API 요청
- **Endpoint**: `POST /api/reviews`
- **Request Body**:
  ```json
  {
    "placeId": "550e8400-e29b-41d4-a716-446655440000",
    "authorName": "맛객",
    "rating": 5,
    "content": "정말 맛있어요!",
    "password": "1234"
  }
  ```

#### 3.3. 서버 응답 처리

**성공 응답 (201 Created):**
```json
{
  "ok": true,
  "data": {
    "reviewId": "660e8400-e29b-41d4-a716-446655440001",
    "placeId": "550e8400-e29b-41d4-a716-446655440000",
    "authorName": "맛객",
    "rating": 5,
    "content": "정말 맛있어요!",
    "createdAt": "2025-10-21T12:34:56Z"
  }
}
```

**처리:**
1. 성공 메시지 표시 (토스트/스낵바)
2. 해당 장소의 상세 페이지로 리다이렉트: `/place/[placeId]`

**에러 응답:**

| HTTP Status | Error Code | 처리 방법 |
|------------|-----------|---------|
| 400 | `INVALID_REVIEW_DATA` | 유효성 에러 메시지를 각 필드에 표시 |
| 404 | `PLACE_NOT_FOUND` | "잘못된 접근입니다" 메시지 표시 후 메인 페이지로 이동 |
| 500 | `REVIEW_CREATE_ERROR` | "저장에 실패했습니다. 잠시 후 다시 시도해주세요" 스낵바 표시 |

### 4. 폼 제출 중 (로딩 상태)

**상태 변화:**
- 저장 버튼 비활성화
- 로딩 인디케이터 표시
- 폼 입력 필드 비활성화 (선택사항)

**사용자 경험:**
- 중복 제출 방지
- 현재 작업이 진행 중임을 시각적으로 표시

## 데이터베이스 상호작용

### 1. 장소 정보 조회 (페이지 진입 시)

**Query:**
```sql
SELECT id, name, address, category
FROM places
WHERE id = $1;
```

**목적:**
- 사용자가 리뷰를 작성하려는 장소의 기본 정보 표시

### 2. 리뷰 생성 (폼 제출 시)

**트랜잭션 시작**

#### 2.1. 리뷰 INSERT
```sql
INSERT INTO reviews (
  place_id,
  author_name,
  rating,
  content,
  password_hash
)
VALUES (
  $1,  -- placeId (UUID)
  $2,  -- authorName (VARCHAR)
  $3,  -- rating (INTEGER)
  $4,  -- content (TEXT)
  $5   -- hashedPassword (VARCHAR, bcrypt)
)
RETURNING id, created_at;
```

#### 2.2. 장소 정보 갱신 (평균 평점, 리뷰 개수)
```sql
UPDATE places
SET
  review_count = (
    SELECT COUNT(*)
    FROM reviews
    WHERE place_id = $1
  ),
  average_rating = (
    SELECT ROUND(AVG(rating)::numeric, 1)
    FROM reviews
    WHERE place_id = $1
  ),
  updated_at = NOW()
WHERE id = $1
RETURNING average_rating, review_count;
```

**트랜잭션 커밋**

**목적:**
- 새로운 리뷰를 데이터베이스에 저장
- 해당 장소의 평균 평점 및 리뷰 개수를 실시간으로 갱신

## 비즈니스 규칙

### 1. 비밀번호 보안
- 비밀번호는 **절대** 평문으로 저장하지 않음
- bcrypt 알고리즘을 사용하여 해시 처리 후 저장
- 클라이언트에서 서버로 전송 시에는 평문 (HTTPS 사용 권장)

### 2. 유효성 검증 규칙

| 필드 | 필수 여부 | 최소 길이 | 최대 길이 | 형식 |
|-----|---------|----------|----------|------|
| 작성자명 | 필수 | 1자 | 50자 | 텍스트 |
| 평점 | 필수 | - | - | 1~5 정수 |
| 리뷰 내용 | 필수 | 1자 | 1000자 | 텍스트 |
| 비밀번호 | 필수 | 4자 | 100자 | 텍스트 |

### 3. Side Effects

리뷰 작성 성공 시 다음과 같은 부수 효과가 발생합니다:

1. **장소 통계 갱신**
   - `places.review_count` 증가
   - `places.average_rating` 재계산

2. **지도 마커 생성** (첫 리뷰인 경우)
   - 해당 장소의 리뷰가 1개 이상이 되면 메인 페이지 지도에 마커 표시

3. **장소 상세 페이지 리뷰 목록**
   - 새로 작성된 리뷰가 최상단에 표시됨

## 에러 처리 전략

### 1. 클라이언트 측 에러

| 에러 시나리오 | 처리 방법 |
|-------------|---------|
| 필수 필드 누락 | 각 필드 하단에 "이 항목은 필수입니다" 메시지 표시 |
| 작성자명 길이 초과 | "작성자명은 최대 50자까지 입력 가능합니다" |
| 리뷰 내용 길이 초과 | "리뷰 내용은 최대 1000자까지 입력 가능합니다" |
| 비밀번호 최소 길이 미달 | "비밀번호는 최소 4자 이상이어야 합니다" |
| 평점 미선택 | "평점을 선택해주세요" |

### 2. 서버 측 에러

| HTTP Status | 처리 방법 | UI 피드백 |
|------------|---------|----------|
| 400 | 서버에서 반환한 유효성 에러를 각 필드에 매핑 | 필드별 에러 메시지 |
| 404 | 메인 페이지로 리다이렉트 | "잘못된 접근입니다" 토스트 |
| 500 | 페이지 유지, 재시도 유도 | "저장에 실패했습니다. 잠시 후 다시 시도해주세요" 스낵바 |
| 네트워크 오류 | 페이지 유지, 재시도 유도 | "네트워크 연결을 확인해주세요" 스낵바 |

## 접근성 (Accessibility)

- 모든 입력 필드는 명확한 `<label>` 태그와 연결
- 에러 메시지는 `aria-describedby`로 입력 필드와 연결
- 폼 제출 중에는 `aria-busy` 속성 설정
- 키보드만으로 모든 기능 사용 가능 (Tab 네비게이션)
- 별점 선택은 키보드 화살표 키로도 조작 가능

## 반응형 디자인

- 모바일: 싱글 컬럼 레이아웃
- 태블릿/데스크톱: 중앙 정렬된 폼 (최대 너비 제한)
- 터치 디바이스에서 입력 필드 및 버튼의 터치 영역 충분히 확보

## 성능 고려사항

- 폼 제출 시 낙관적 UI 업데이트 (선택사항)
- API 요청 중 중복 제출 방지 (디바운싱)
- 장소 정보는 클라이언트 측 캐싱 가능 (React Query 사용 시)
