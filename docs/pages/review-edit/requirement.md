# 리뷰 수정 페이지 요구사항

## 1. 페이지 개요

**경로**: `/edit/[reviewId]`
**접근 방식**: 장소 상세 페이지에서 '수정' 버튼 클릭 및 비밀번호 인증 성공 시 진입

리뷰 수정 페이지는 사용자가 이전에 작성한 리뷰의 내용을 수정할 수 있는 페이지입니다. 비밀번호 인증을 통해 본인 확인 후 작성자명, 평점, 리뷰 내용을 수정할 수 있습니다.

---

## 2. 사용자가 할 수 있는 행동

### 2.1 페이지 진입 전: 비밀번호 인증

1. **수정 버튼 클릭**
   - 장소 상세 페이지(`/place/[placeId]`)의 리뷰 목록에서 특정 리뷰의 '수정' 버튼을 클릭
   - 비밀번호 확인 모달이 표시됨

2. **비밀번호 입력 및 인증**
   - 비밀번호 입력 필드에 리뷰 작성 시 설정했던 비밀번호를 입력
   - '확인' 버튼을 클릭하여 인증 요청
   - 인증 성공 시 리뷰 수정 페이지로 이동

### 2.2 페이지 진입 후: 리뷰 수정

1. **기존 데이터 확인**
   - 페이지 로드 시 기존 리뷰 데이터(작성자명, 평점, 내용)가 폼에 자동으로 채워짐
   - 대상 장소 정보가 상단에 고정 표시됨

2. **리뷰 내용 수정**
   - 작성자명 수정: 텍스트 입력 필드에서 작성자명 변경 (1-50자)
   - 평점 수정: 별점 선택 UI에서 평점 변경 (1-5점)
   - 리뷰 내용 수정: 텍스트 영역에서 리뷰 내용 변경 (1-1000자)

3. **수정 완료**
   - '수정 완료' 버튼 클릭
   - 유효성 검증 통과 시 서버로 수정된 데이터 전송
   - 성공 시 장소 상세 페이지로 자동 리다이렉트

4. **취소**
   - '취소' 버튼 또는 뒤로가기 클릭
   - 수정 사항을 저장하지 않고 장소 상세 페이지로 돌아감

---

## 3. 데이터 흐름

### 3.1 페이지 진입 전 (비밀번호 인증)

```
[사용자] --'수정' 버튼 클릭--> [비밀번호 확인 모달 표시]
                                        │
                                        ▼
                            [비밀번호 입력 및 '확인' 클릭]
                                        │
                                        ▼
                            [POST /api/reviews/:reviewId/verify]
                            {password: string}
                                        │
                           ┌────────────┴────────────┐
                           ▼                         ▼
                    [인증 성공]                [인증 실패]
                           │                         │
                           ▼                         ▼
            [GET /api/reviews/:reviewId]    [오류 메시지 표시]
            (기존 리뷰 데이터 조회)          "비밀번호가 일치하지 않습니다"
                           │
                           ▼
            [리뷰 수정 페이지로 이동]
            (/edit/[reviewId])
```

### 3.2 페이지 로드 시 (기존 데이터 조회)

```
[리뷰 수정 페이지 진입]
         │
         ▼
[GET /api/reviews/:reviewId]
         │
         ▼
[서버] --DB 조회--> [reviews 테이블]
                    SELECT id, place_id, author_name,
                           rating, content, created_at, updated_at
                    WHERE id = :reviewId
         │
         ▼
[응답 데이터]
{
  id: string,
  placeId: string,
  authorName: string,
  rating: number,
  content: string,
  createdAt: string,
  updatedAt: string
}
         │
         ▼
[폼에 데이터 자동 입력]
```

### 3.3 수정 완료 시 (데이터 업데이트)

```
[사용자] --'수정 완료' 클릭--> [클라이언트 측 유효성 검증]
                                        │
                           ┌────────────┴────────────┐
                           ▼                         ▼
                    [검증 성공]                [검증 실패]
                           │                         │
                           │                         ▼
                           │              [필드별 오류 메시지 표시]
                           │
                           ▼
                [PATCH /api/reviews/:reviewId]
                {authorName, rating, content}
                           │
                           ▼
                [서버] --트랜잭션 시작--> [DB]
                           │
                           ▼
                [1. UPDATE reviews]
                SET author_name = :authorName,
                    rating = :rating,
                    content = :content
                WHERE id = :reviewId
                           │
                           ▼
                [2. UPDATE places]
                SET average_rating = (
                  SELECT ROUND(AVG(rating)::numeric, 1)
                  FROM reviews
                  WHERE place_id = :placeId
                )
                WHERE id = :placeId
                           │
                           ▼
                [트랜잭션 커밋]
                           │
                           ▼
                [200 OK 응답]
                {data: updatedReview}
                           │
                           ▼
                [장소 상세 페이지로 리다이렉트]
                (/place/[placeId])
```

---

## 4. 데이터베이스 상호작용

### 4.1 사용되는 테이블

1. **reviews 테이블**
   - 리뷰 데이터를 저장하고 수정하는 주요 테이블
   - 필드: `id`, `place_id`, `author_name`, `rating`, `content`, `password_hash`, `created_at`, `updated_at`

2. **places 테이블**
   - 장소 정보 및 평균 평점을 저장하는 테이블
   - 리뷰 수정 시 `average_rating` 필드가 재계산되어 업데이트됨

### 4.2 주요 DB 쿼리

#### 4.2.1 비밀번호 인증 (POST /api/reviews/:reviewId/verify)

```sql
-- 리뷰의 password_hash 조회
SELECT password_hash
FROM reviews
WHERE id = $1;

-- 애플리케이션 레벨에서 bcrypt.compare()로 해시값 비교
```

#### 4.2.2 리뷰 데이터 조회 (GET /api/reviews/:reviewId)

```sql
-- 리뷰 전체 데이터 조회 (비밀번호 제외)
SELECT id, place_id, author_name, rating, content, created_at, updated_at
FROM reviews
WHERE id = $1;
```

#### 4.2.3 리뷰 수정 (PATCH /api/reviews/:reviewId)

```sql
-- 1. 리뷰 업데이트 (updated_at은 트리거로 자동 갱신)
UPDATE reviews
SET author_name = $2,
    rating = $3,
    content = $4
WHERE id = $1
RETURNING id, place_id, author_name, rating, content, updated_at;

-- 2. 장소의 평균 평점 재계산
UPDATE places
SET average_rating = (
  SELECT ROUND(AVG(rating)::numeric, 1)
  FROM reviews
  WHERE place_id = $2
)
WHERE id = $2;
```

### 4.3 데이터 흐름 시퀀스

```
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌───────────┐
│ 사용자  │     │  클라이언트 │     │   API 서버   │     │    DB     │
└────┬────┘     └────┬────┘     └──────┬──────┘     └─────┬─────┘
     │               │                 │                  │
     │ 수정 버튼 클릭 │                 │                  │
     ├──────────────>│                 │                  │
     │               │ POST verify     │                  │
     │               ├────────────────>│                  │
     │               │                 │ SELECT password  │
     │               │                 ├─────────────────>│
     │               │                 │<─────────────────┤
     │               │                 │ (해시값 비교)     │
     │               │<────────────────┤                  │
     │ (인증 성공)    │                 │                  │
     │               │ GET review      │                  │
     │               ├────────────────>│                  │
     │               │                 │ SELECT review    │
     │               │                 ├─────────────────>│
     │               │                 │<─────────────────┤
     │               │<────────────────┤                  │
     │<──────────────┤                 │                  │
     │ (폼 표시)      │                 │                  │
     │               │                 │                  │
     │ 수정 완료 클릭 │                 │                  │
     ├──────────────>│                 │                  │
     │               │ PATCH review    │                  │
     │               ├────────────────>│                  │
     │               │                 │ BEGIN TRANSACTION│
     │               │                 │                  │
     │               │                 │ UPDATE reviews   │
     │               │                 ├─────────────────>│
     │               │                 │<─────────────────┤
     │               │                 │ UPDATE places    │
     │               │                 ├─────────────────>│
     │               │                 │<─────────────────┤
     │               │                 │ COMMIT           │
     │               │<────────────────┤                  │
     │<──────────────┤                 │                  │
     │ (리다이렉트)   │                 │                  │
```

---

## 5. Edge Cases 및 오류 처리

### 5.1 비밀번호 인증 단계

| Edge Case | 처리 방법 |
|-----------|----------|
| 비밀번호 미입력 | 모달 내 "비밀번호를 입력하세요" 오류 메시지 표시 |
| 비밀번호 불일치 | 모달 내 "비밀번호가 일치하지 않습니다" 오류 메시지 표시 |
| 서버 오류 (인증) | 모달 닫고 "오류가 발생했습니다. 다시 시도해주세요" 스낵바 표시 |
| 리뷰가 존재하지 않음 | "해당 리뷰를 찾을 수 없습니다" 오류 메시지 후 장소 상세 페이지로 리다이렉트 |

### 5.2 리뷰 수정 단계

| Edge Case | 처리 방법 |
|-----------|----------|
| 필수 필드 누락 | 각 필드 하단에 "작성자명을 입력하세요", "평점을 선택하세요" 등 오류 메시지 표시 |
| 작성자명 길이 초과 (50자) | "작성자명은 최대 50자까지 입력 가능합니다" 오류 메시지 표시 |
| 리뷰 내용 길이 초과 (1000자) | "리뷰 내용은 최대 1000자까지 입력 가능합니다" 오류 메시지 표시 |
| 서버 오류 (수정) | 리뷰 수정 페이지에 머무르며 "저장에 실패했습니다. 잠시 후 다시 시도해주세요" 모달 또는 스낵바 표시 |
| 네트워크 오류 | "네트워크 연결을 확인해주세요" 오류 메시지 표시 |

---

## 6. 비즈니스 규칙

### 6.1 수정 가능한 필드

- **작성자명** (`author_name`): 1-50자
- **평점** (`rating`): 1-5 정수
- **리뷰 내용** (`content`): 1-1000자

### 6.2 수정 불가능한 필드

- **비밀번호**: 리뷰 작성 시 설정한 비밀번호는 수정 불가 (인증용으로만 사용)
- **리뷰 ID**: 변경 불가
- **장소 ID**: 변경 불가
- **작성일** (`created_at`): 최초 작성 시각 유지

### 6.3 자동 갱신 필드

- **수정일** (`updated_at`): 트리거를 통해 자동으로 현재 시각으로 갱신
- **장소 평균 평점** (`places.average_rating`): 리뷰 수정 시 자동으로 재계산

### 6.4 비밀번호 정책

- 비밀번호는 원본을 저장하지 않으며, bcrypt 등의 단방향 해시 알고리즘으로 처리
- 비밀번호 인증은 클라이언트가 전송한 평문 비밀번호를 서버에서 해시하여 DB의 해시값과 비교

---

## 7. UI/UX 요구사항

### 7.1 페이지 레이아웃

1. **상단 영역**: 대상 장소 정보 (가게명, 주소) - 리뷰 작성 페이지와 동일
2. **폼 영역**:
   - 작성자명 입력 필드 (텍스트)
   - 평점 선택 UI (별점)
   - 리뷰 내용 입력 필드 (텍스트 영역)
3. **하단 버튼 영역**: '수정 완료', '취소' 버튼

### 7.2 폼 초기화

- 페이지 로드 시 기존 리뷰 데이터가 자동으로 폼에 채워져야 함
- 로딩 상태 표시: 데이터 조회 중 스켈레톤 UI 또는 로딩 스피너 표시

### 7.3 실시간 피드백

- 입력 중 문자 수 카운터 표시 (예: "50자 중 15자")
- 유효성 검증 실패 시 해당 필드 하단에 즉시 오류 메시지 표시
- 수정 완료 버튼은 폼이 유효할 때만 활성화 (선택 사항)

### 7.4 접근성

- 모든 입력 필드에 적절한 `label` 제공
- 오류 메시지는 스크린 리더가 읽을 수 있도록 `aria-live` 속성 사용
- 키보드 네비게이션 지원

---

## 8. 성능 고려사항

- 페이지 진입 시 리뷰 데이터 조회는 이미 비밀번호 인증 시 완료되었으므로, 추가 API 호출 최소화
- 장소 정보는 URL에서 전달되거나 별도 API 호출로 조회 (캐싱 권장)
- 수정 완료 후 장소 상세 페이지로 리다이렉트 시 React Query 캐시 무효화하여 최신 데이터 표시

---

## 9. 관련 유스케이스

- **UC-002**: 신규 리뷰 작성 및 저장 (폼 UI 재사용)
- **UC-004**: 기존 리뷰 삭제 (비밀번호 인증 로직 공유)
- **UC-005**: 장소 상세 정보 조회 (수정 후 리다이렉트 대상 페이지)
